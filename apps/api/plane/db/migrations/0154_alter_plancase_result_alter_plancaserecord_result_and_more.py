# Generated by Django 4.2.24 on 2025-12-23 03:49

from django.db import migrations, models

def remove_duplicate_plan_modules(apps, schema_editor):
    PlanModule = apps.get_model('db', 'PlanModule')  # 替换为你的 app 名
    # 只考虑未删除的记录（deleted_at is null）
    qs = PlanModule.objects.filter(deleted_at__isnull=True).order_by('created_at')
    seen = set()
    duplicates = []
    for obj in qs:
        key = (obj.repository_id, obj.name)
        if key in seen:
            # 删除重复项
            obj.delete()  # 或者标记 soft delete：obj.deleted_at = now(); obj.save()
            duplicates.append(key)
        else:
            seen.add(key)
    if duplicates:
        print(f"Removed duplicate PlanModule entries for keys: {set(duplicates)}")


class Migration(migrations.Migration):
    atomic = False

    dependencies = [
        ('db', '0153_alter_deployboard_project_and_more'),
    ]

    operations = [
        migrations.RunPython(remove_duplicate_plan_modules, reverse_code=migrations.RunPython.noop),
        migrations.AlterField(
            model_name='plancase',
            name='result',
            field=models.CharField(choices=[('成功', 'green'), ('失败', 'red'), ('阻塞', 'gold'), ('未执行', 'gray'), ('无效', 'gray')], default='未执行', verbose_name='PlanCase Execute Result'),
        ),
        migrations.AlterField(
            model_name='plancaserecord',
            name='result',
            field=models.CharField(choices=[('成功', 'green'), ('失败', 'red'), ('阻塞', 'gold'), ('无效', 'gray')], default='成功', verbose_name='PlanCaseRecord Result'),
        ),
        migrations.AddConstraint(
            model_name='planmodule',
            constraint=models.UniqueConstraint(condition=models.Q(('deleted_at__isnull', True), ('repository__isnull', False)), fields=('repository', 'name'), name='unique_plane_module_repository_name_when_not_deleted'),
        ),
    ]
